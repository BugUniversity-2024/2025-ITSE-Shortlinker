# 短链接系统数据库设计文档

## 数据库架构概述

### 技术选型
- **主数据库**: MySQL 8.0+ / PostgreSQL 13+
- **缓存层**: Redis 6.0+
- **搜索引擎**: Elasticsearch 7.0+ (可选)
- **消息队列**: RabbitMQ / Apache Kafka (用于异步处理)

### 架构设计原则
1. **读写分离**: 使用主从复制，读操作分发到从库
2. **分片策略**: 基于用户ID进行水平分片
3. **缓存策略**: 多层缓存，包括应用层缓存和数据库查询缓存
4. **数据归档**: 定期归档历史点击数据

## 详细表结构设计

### 1. 用户相关表

#### 用户表 (users)
```sql
CREATE TABLE users (
    id CHAR(36) PRIMARY KEY COMMENT '用户唯一标识UUID',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    email VARCHAR(100) UNIQUE NOT NULL COMMENT '邮箱地址',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希值',
    salt VARCHAR(32) NOT NULL COMMENT '密码盐值',
    api_key VARCHAR(64) UNIQUE NOT NULL COMMENT 'API密钥',
    plan_type ENUM('free', 'pro', 'enterprise') DEFAULT 'free' COMMENT '账户类型',
    status ENUM('active', 'suspended', 'deleted') DEFAULT 'active' COMMENT '账户状态',
    email_verified BOOLEAN DEFAULT FALSE COMMENT '邮箱是否已验证',
    two_factor_enabled BOOLEAN DEFAULT FALSE COMMENT '是否启用双因子认证',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    last_login TIMESTAMP NULL COMMENT '最后登录时间',
    login_count INT DEFAULT 0 COMMENT '登录次数',
    
    INDEX idx_email (email),
    INDEX idx_api_key (api_key),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='用户表';
```

#### 用户配额表 (user_quotas)
```sql
CREATE TABLE user_quotas (
    user_id CHAR(36) PRIMARY KEY COMMENT '用户ID',
    max_links INT NOT NULL DEFAULT 100 COMMENT '最大链接数量',
    max_clicks_per_month INT NOT NULL DEFAULT 1000 COMMENT '每月最大点击量',
    max_custom_domains INT NOT NULL DEFAULT 0 COMMENT '最大自定义域名数量',
    analytics_retention_days INT NOT NULL DEFAULT 30 COMMENT '统计数据保留天数',
    allow_password_protection BOOLEAN DEFAULT FALSE COMMENT '是否允许密码保护',
    allow_custom_code BOOLEAN DEFAULT TRUE COMMENT '是否允许自定义短码',
    current_links INT DEFAULT 0 COMMENT '当前链接数量',
    current_month_clicks INT DEFAULT 0 COMMENT '当月点击量',
    quota_reset_date DATE NOT NULL COMMENT '配额重置日期',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='用户配额表';
```

### 2. 短链接核心表

#### 短链接表 (short_links)
```sql
CREATE TABLE short_links (
    id CHAR(36) PRIMARY KEY COMMENT '链接唯一标识',
    user_id CHAR(36) NOT NULL COMMENT '创建用户ID',
    short_code VARCHAR(20) UNIQUE NOT NULL COMMENT '短链接代码',
    original_url TEXT NOT NULL COMMENT '原始长URL',
    title VARCHAR(200) NULL COMMENT '链接标题',
    description TEXT NULL COMMENT '链接描述',
    custom_domain VARCHAR(100) NULL COMMENT '自定义域名',
    favicon_url VARCHAR(500) NULL COMMENT '网站图标URL',
    
    -- 访问控制
    password_hash VARCHAR(255) NULL COMMENT '访问密码哈希（可选）',
    is_private BOOLEAN DEFAULT FALSE COMMENT '是否为私有链接',
    access_count_limit INT NULL COMMENT '访问次数限制',
    
    -- 时间控制
    expires_at TIMESTAMP NULL COMMENT '过期时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    last_clicked_at TIMESTAMP NULL COMMENT '最后点击时间',
    
    -- 状态和统计
    status ENUM('active', 'disabled', 'expired', 'deleted') DEFAULT 'active' COMMENT '链接状态',
    click_count INT DEFAULT 0 COMMENT '总点击次数',
    unique_click_count INT DEFAULT 0 COMMENT '独立访客点击次数',
    
    -- UTM参数（用于营销追踪）
    utm_source VARCHAR(100) NULL COMMENT 'UTM来源',
    utm_medium VARCHAR(100) NULL COMMENT 'UTM媒介',
    utm_campaign VARCHAR(100) NULL COMMENT 'UTM活动',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    
    INDEX idx_short_code (short_code),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_expires_at (expires_at),
    INDEX idx_user_status (user_id, status),
    INDEX idx_domain_code (custom_domain, short_code)
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='短链接主表';
```

#### 短链接元数据表 (link_metadata)
```sql
CREATE TABLE link_metadata (
    link_id CHAR(36) PRIMARY KEY COMMENT '链接ID',
    page_title VARCHAR(500) NULL COMMENT '目标页面标题',
    page_description TEXT NULL COMMENT '目标页面描述',
    page_image_url VARCHAR(1000) NULL COMMENT '目标页面图片URL',
    page_keywords TEXT NULL COMMENT '目标页面关键词',
    domain_name VARCHAR(100) NULL COMMENT '目标域名',
    is_safe BOOLEAN DEFAULT TRUE COMMENT '是否为安全链接',
    malware_check_date TIMESTAMP NULL COMMENT '恶意软件检查时间',
    ssl_status ENUM('valid', 'invalid', 'unknown') DEFAULT 'unknown' COMMENT 'SSL证书状态',
    response_time_ms INT NULL COMMENT '响应时间（毫秒）',
    last_checked TIMESTAMP NULL COMMENT '最后检查时间',
    
    FOREIGN KEY (link_id) REFERENCES short_links(id) ON DELETE CASCADE,
    INDEX idx_domain (domain_name),
    INDEX idx_last_checked (last_checked)
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='链接元数据表';
```

### 3. 分类和标签系统

#### 标签表 (tags)
```sql
CREATE TABLE tags (
    id CHAR(36) PRIMARY KEY COMMENT '标签ID',
    user_id CHAR(36) NOT NULL COMMENT '用户ID',
    name VARCHAR(50) NOT NULL COMMENT '标签名称',
    color VARCHAR(7) DEFAULT '#007bff' COMMENT '标签颜色（十六进制）',
    description TEXT NULL COMMENT '标签描述',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_tag (user_id, name),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='标签表';
```

#### 链接标签关联表 (link_tags)
```sql
CREATE TABLE link_tags (
    link_id CHAR(36) NOT NULL COMMENT '链接ID',
    tag_id CHAR(36) NOT NULL COMMENT '标签ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '关联创建时间',
    
    PRIMARY KEY (link_id, tag_id),
    FOREIGN KEY (link_id) REFERENCES short_links(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
    INDEX idx_tag_id (tag_id)
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='链接标签关联表';
```

### 4. 点击统计表

#### 点击记录表 (click_logs)
```sql
CREATE TABLE click_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '记录ID',
    link_id CHAR(36) NOT NULL COMMENT '链接ID',
    
    -- 访问者信息
    ip_address VARCHAR(45) NOT NULL COMMENT 'IP地址（已脱敏）',
    ip_hash VARCHAR(64) NOT NULL COMMENT 'IP哈希值（用于去重）',
    user_agent TEXT NULL COMMENT '用户代理字符串',
    fingerprint VARCHAR(64) NULL COMMENT '浏览器指纹',
    
    -- 来源信息
    referer TEXT NULL COMMENT '来源页面',
    referer_domain VARCHAR(100) NULL COMMENT '来源域名',
    utm_source VARCHAR(100) NULL COMMENT 'UTM来源',
    utm_medium VARCHAR(100) NULL COMMENT 'UTM媒介',
    utm_campaign VARCHAR(100) NULL COMMENT 'UTM活动',
    
    -- 地理位置信息
    country_code CHAR(2) NULL COMMENT '国家代码',
    country_name VARCHAR(50) NULL COMMENT '国家名称',
    region VARCHAR(50) NULL COMMENT '地区/省份',
    city VARCHAR(100) NULL COMMENT '城市',
    timezone VARCHAR(50) NULL COMMENT '时区',
    latitude DECIMAL(10,8) NULL COMMENT '纬度',
    longitude DECIMAL(11,8) NULL COMMENT '经度',
    
    -- 设备信息
    device_type ENUM('desktop', 'mobile', 'tablet', 'other') NULL COMMENT '设备类型',
    device_brand VARCHAR(50) NULL COMMENT '设备品牌',
    device_model VARCHAR(100) NULL COMMENT '设备型号',
    browser_name VARCHAR(50) NULL COMMENT '浏览器名称',
    browser_version VARCHAR(20) NULL COMMENT '浏览器版本',
    os_name VARCHAR(50) NULL COMMENT '操作系统名称',
    os_version VARCHAR(20) NULL COMMENT '操作系统版本',
    screen_resolution VARCHAR(20) NULL COMMENT '屏幕分辨率',
    
    -- 时间信息
    clicked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '点击时间',
    local_time_offset INT NULL COMMENT '本地时间偏移（分钟）',
    
    -- 性能信息
    response_time_ms INT NULL COMMENT '响应时间（毫秒）',
    is_bot BOOLEAN DEFAULT FALSE COMMENT '是否为机器人访问',
    
    FOREIGN KEY (link_id) REFERENCES short_links(id) ON DELETE CASCADE,
    
    INDEX idx_link_id (link_id),
    INDEX idx_clicked_at (clicked_at),
    INDEX idx_country (country_code),
    INDEX idx_device (device_type),
    INDEX idx_browser (browser_name),
    INDEX idx_link_time (link_id, clicked_at),
    INDEX idx_ip_hash (ip_hash)
    
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='点击记录表'
PARTITION BY RANGE (YEAR(clicked_at)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 每日统计汇总表 (daily_stats)
```sql
CREATE TABLE daily_stats (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '记录ID',
    link_id CHAR(36) NOT NULL COMMENT '链接ID',
    date DATE NOT NULL COMMENT '统计日期',
    
    total_clicks INT DEFAULT 0 COMMENT '总点击数',
    unique_clicks INT DEFAULT 0 COMMENT '独立访客数',
    
    -- 按设备类型统计
    desktop_clicks INT DEFAULT 0 COMMENT '桌面端点击数',
    mobile_clicks INT DEFAULT 0 COMMENT '移动端点击数',
    tablet_clicks INT DEFAULT 0 COMMENT '平板端点击数',
    
    -- 按来源统计
    direct_clicks INT DEFAULT 0 COMMENT '直接访问点击数',
    social_clicks INT DEFAULT 0 COMMENT '社交媒体点击数',
    search_clicks INT DEFAULT 0 COMMENT '搜索引擎点击数',
    referral_clicks INT DEFAULT 0 COMMENT '外链点击数',
    
    -- 地理统计
    top_country VARCHAR(2) NULL COMMENT '主要访问国家',
    top_city VARCHAR(100) NULL COMMENT '主要访问城市',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '统计生成时间',
    
    FOREIGN KEY (link_id) REFERENCES short_links(id) ON DELETE CASCADE,
    UNIQUE KEY unique_link_date (link_id, date),
    INDEX idx_date (date),
    INDEX idx_link_id (link_id)
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='每日统计汇总表';
```

### 5. 自定义域名表

#### 自定义域名表 (custom_domains)
```sql
CREATE TABLE custom_domains (
    id CHAR(36) PRIMARY KEY COMMENT '域名ID',
    user_id CHAR(36) NOT NULL COMMENT '用户ID',
    domain VARCHAR(100) UNIQUE NOT NULL COMMENT '域名',
    status ENUM('pending', 'active', 'failed', 'suspended') DEFAULT 'pending' COMMENT '域名状态',
    ssl_status ENUM('none', 'pending', 'active', 'failed') DEFAULT 'none' COMMENT 'SSL状态',
    
    -- DNS配置
    cname_target VARCHAR(100) NOT NULL COMMENT 'CNAME指向目标',
    txt_verification VARCHAR(100) NULL COMMENT 'TXT验证记录',
    is_verified BOOLEAN DEFAULT FALSE COMMENT '是否已验证',
    
    -- SSL证书信息
    ssl_provider VARCHAR(50) NULL COMMENT 'SSL提供商',
    ssl_issued_at TIMESTAMP NULL COMMENT 'SSL颁发时间',
    ssl_expires_at TIMESTAMP NULL COMMENT 'SSL过期时间',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    verified_at TIMESTAMP NULL COMMENT '验证时间',
    last_check TIMESTAMP NULL COMMENT '最后检查时间',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='自定义域名表';
```

### 6. 系统配置和缓存表

#### 系统配置表 (system_configs)
```sql
CREATE TABLE system_configs (
    config_key VARCHAR(100) PRIMARY KEY COMMENT '配置键',
    config_value TEXT NOT NULL COMMENT '配置值',
    config_type ENUM('string', 'number', 'boolean', 'json') DEFAULT 'string' COMMENT '配置类型',
    description TEXT NULL COMMENT '配置描述',
    is_public BOOLEAN DEFAULT FALSE COMMENT '是否为公开配置',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    updated_by CHAR(36) NULL COMMENT '更新者ID'
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='系统配置表';
```

#### 短码池表 (short_code_pool)
```sql
CREATE TABLE short_code_pool (
    short_code VARCHAR(20) PRIMARY KEY COMMENT '短码',
    is_used BOOLEAN DEFAULT FALSE COMMENT '是否已使用',
    reserved_until TIMESTAMP NULL COMMENT '保留到期时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '生成时间',
    
    INDEX idx_is_used (is_used),
    INDEX idx_reserved_until (reserved_until)
) ENGINE=InnoDB CHARSET=utf8mb4 COMMENT='短码池表';
```

## 缓存策略设计

### Redis 缓存结构

#### 1. 短链接缓存
```
Key格式: "link:{short_code}"
TTL: 1小时
数据结构: Hash
字段:
- original_url: 原始URL
- status: 链接状态
- expires_at: 过期时间
- click_count: 点击次数
```

#### 2. 用户会话缓存
```
Key格式: "session:{api_key}"
TTL: 24小时
数据结构: Hash
字段:
- user_id: 用户ID
- plan_type: 账户类型
- quotas: 配额信息
```

#### 3. 统计数据缓存
```
Key格式: "stats:{link_id}:{date}"
TTL: 24小时
数据结构: Hash
字段:
- total_clicks: 总点击数
- unique_clicks: 独立访客数
- top_country: 主要国家
- top_device: 主要设备类型
```

## 数据库性能优化

### 1. 分区策略
- 点击记录表按年份分区
- 统计表按月份分区
- 历史数据定期归档

### 2. 索引优化
- 复合索引优化查询性能
- 定期分析慢查询日志
- 使用覆盖索引减少回表查询

### 3. 读写分离
- 主库处理写操作
- 从库处理读操作和统计查询
- 使用负载均衡分发读请求

### 4. 数据归档
- 定期归档历史点击数据
- 保留汇总统计信息
- 实施数据生命周期管理

## 安全性考虑

### 1. 数据脱敏
- IP地址哈希处理
- 用户代理信息过滤
- 敏感信息加密存储

### 2. 访问控制
- API密钥认证
- 权限分级管理
- 操作日志记录

### 3. 防护措施
- SQL注入防护
- XSS攻击防护
- 恶意URL检测

这个数据库设计文档提供了完整的表结构、索引策略、缓存设计和性能优化方案，可以支撑一个高性能的短链接系统。