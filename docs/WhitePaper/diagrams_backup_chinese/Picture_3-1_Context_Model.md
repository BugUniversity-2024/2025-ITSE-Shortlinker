# Picture 3-1: Context Model Diagram
# å›¾ 3-1:ä¸Šä¸‹æ–‡æ¨¡å‹å›¾

```mermaid
graph TB
    subgraph "å¤–éƒ¨å®ä½“ External Entities"
        User[æ™®é€šç”¨æˆ·<br>End Users]
        Admin[ç³»ç»Ÿç®¡ç†å‘˜<br>System Admins]
        TeamMember[å›¢é˜Ÿæˆå‘˜<br>Team Members]
        APIClient[APIå®¢æˆ·ç«¯<br>API Clients]
    end

    subgraph "TinyBridge çŸ­é“¾æ¥ç³»ç»Ÿ<br>TinyBridge Short Link System"
        System[TinyBridge<br>Core System]
    end

    subgraph "å¤–éƒ¨ç³»ç»Ÿ External Systems"
        EmailService[é‚®ä»¶æœåŠ¡<br>Email Service<br>SMTP]
        GeoIPService[åœ°ç†ä½ç½®æœåŠ¡<br>GeoIP Service<br>geoip-lite]
        CDN[å†…å®¹åˆ†å‘ç½‘ç»œ<br>CDN<br>CloudFlare/Aliyun]
        MonitorService[ç›‘æ§æœåŠ¡<br>Monitoring<br>Prometheus/Grafana]
    end

    subgraph "æ•°æ®å­˜å‚¨ Data Storage"
        PostgreSQL[(PostgreSQL<br>ä¸»æ•°æ®åº“)]
        Redis[(Redis<br>ç¼“å­˜æ•°æ®åº“)]
        FileStorage[æ–‡ä»¶å­˜å‚¨<br>File Storage<br>æœ¬åœ°/OSS]
    end

    User -->|æ³¨å†Œ/ç™»å½•| System
    User -->|åˆ›å»ºçŸ­é“¾æ¥| System
    User -->|è®¿é—®çŸ­é“¾æ¥| System
    User -->|æŸ¥çœ‹åˆ†ææ•°æ®| System
    User -->|ç¼–è¾‘è½åœ°é¡µ| System

    TeamMember -->|å›¢é˜Ÿåä½œ| System
    TeamMember -->|å…±äº«é“¾æ¥| System

    Admin -->|ç³»ç»Ÿç®¡ç†| System
    Admin -->|ç›‘æ§æ€§èƒ½| System

    APIClient -->|æ‰¹é‡æ“ä½œ| System
    APIClient -->|å¯¼å…¥/å¯¼å‡º| System

    System -->|å‘é€éªŒè¯é‚®ä»¶| EmailService
    System -->|å‘é€é‚€è¯·é‚®ä»¶| EmailService

    System -->|IPåœ°ç†å®šä½| GeoIPService

    System -->|é™æ€èµ„æºåŠ é€Ÿ| CDN

    System -->|æ€§èƒ½æŒ‡æ ‡| MonitorService
    System -->|æ—¥å¿—æ”¶é›†| MonitorService

    System -->|è¯»å†™æ•°æ®| PostgreSQL
    System -->|ç¼“å­˜æŸ¥è¯¢| Redis
    System -->|å­˜å‚¨äºŒç»´ç | FileStorage

    EmailService -.->|é‚®ä»¶é€šçŸ¥| User
    EmailService -.->|é‚€è¯·é€šçŸ¥| TeamMember

    style System fill:#3B82F6,color:#fff
    style User fill:#10B981,color:#fff
    style TeamMember fill:#10B981,color:#fff
    style Admin fill:#F59E0B,color:#fff
    style APIClient fill:#8B5CF6,color:#fff
    style EmailService fill:#EC4899,color:#fff
    style GeoIPService fill:#EC4899,color:#fff
    style CDN fill:#EC4899,color:#fff
    style MonitorService fill:#EC4899,color:#fff
    style PostgreSQL fill:#6366F1,color:#fff
    style Redis fill:#EF4444,color:#fff
    style FileStorage fill:#6366F1,color:#fff
```

## ä¸Šä¸‹æ–‡æ¨¡å‹è¯´æ˜

### ğŸŒ ç³»ç»Ÿè¾¹ç•Œå®šä¹‰

TinyBridge çŸ­é“¾æ¥ç³»ç»Ÿæ˜¯ä¸€ä¸ª**ç‹¬ç«‹çš„ Web åº”ç”¨ç¨‹åº**,é€šè¿‡ HTTP/HTTPS åè®®ä¸ºç”¨æˆ·æä¾›çŸ­é“¾æ¥ç”Ÿæˆã€ç®¡ç†ã€åˆ†æå’Œè½åœ°é¡µç¼–è¾‘æœåŠ¡ã€‚

---

### ğŸ‘¥ å¤–éƒ¨å®ä½“ (External Entities)

#### 1. æ™®é€šç”¨æˆ· (End Users)

**è§’è‰²å®šä¹‰**: ä½¿ç”¨ TinyBridge åˆ›å»ºå’Œç®¡ç†çŸ­é“¾æ¥çš„ä¸ªäººç”¨æˆ·ã€‚

**äº¤äº’æ–¹å¼**:
- **æ³¨å†Œ/ç™»å½•**: é€šè¿‡é‚®ç®± + å¯†ç æ³¨å†Œè´¦å·,ç™»å½•åè·å¾— JWT Token
- **åˆ›å»ºçŸ­é“¾æ¥**: æäº¤é•¿é“¾æ¥,è·å¾—è‡ªå®šä¹‰æˆ–éšæœºç”Ÿæˆçš„çŸ­é“¾æ¥
- **è®¿é—®çŸ­é“¾æ¥**: é€šè¿‡æµè§ˆå™¨è®¿é—® `tinybridge.link/{code}`,é‡å®šå‘åˆ°ç›®æ ‡ URL
- **æŸ¥çœ‹åˆ†ææ•°æ®**: æŸ¥çœ‹ç‚¹å‡»é‡ã€åœ°ç†åˆ†å¸ƒã€è®¾å¤‡ç±»å‹ç­‰ç»Ÿè®¡ä¿¡æ¯
- **ç¼–è¾‘è½åœ°é¡µ**: ä½¿ç”¨å¯è§†åŒ–ç¼–è¾‘å™¨æˆ–ä»£ç ç¼–è¾‘å™¨è‡ªå®šä¹‰è½åœ°é¡µ

**å…¸å‹ç”¨ä¾‹**:
```
åœºæ™¯: å­¦ç”Ÿç¤¾å›¢æ´»åŠ¨æ¨å¹¿
è¾“å…¥: https://example.com/scnu-programming-competition-2025
è¾“å‡º: https://tinybridge.link/scnu2025
ç”¨é€”: åœ¨æµ·æŠ¥ã€å¾®ä¿¡ç¾¤ä¸­åˆ†äº«,è·Ÿè¸ªè®¿é—®æ¥æº
```

---

#### 2. å›¢é˜Ÿæˆå‘˜ (Team Members)

**è§’è‰²å®šä¹‰**: åŠ å…¥å›¢é˜Ÿçš„ç”¨æˆ·,ä¸å…¶ä»–æˆå‘˜åä½œç®¡ç†å…±äº«é“¾æ¥ã€‚

**äº¤äº’æ–¹å¼**:
- **å›¢é˜Ÿåä½œ**: æ¥å—é‚€è¯·åŠ å…¥å›¢é˜Ÿ,æŸ¥çœ‹å›¢é˜Ÿæˆå‘˜
- **å…±äº«é“¾æ¥**: åˆ›å»ºå½’å±äºå›¢é˜Ÿçš„çŸ­é“¾æ¥,å›¢é˜Ÿæˆå‘˜å…±åŒç®¡ç†
- **æƒé™ç®¡ç†**: æ ¹æ®è§’è‰² (Owner/Admin/Member) æ‹¥æœ‰ä¸åŒæƒé™

**å…¸å‹ç”¨ä¾‹**:
```
åœºæ™¯: è¥é”€å›¢é˜Ÿæ´»åŠ¨
å›¢é˜Ÿ: "SCNU å­¦ç”Ÿä¼š" (5 åæˆå‘˜)
å…±äº«é“¾æ¥: 10 ä¸ªæ´»åŠ¨æ¨å¹¿é“¾æ¥
åä½œ: æˆå‘˜ A åˆ›å»ºé“¾æ¥,æˆå‘˜ B æŸ¥çœ‹æ•°æ®,æˆå‘˜ C ç¼–è¾‘è½åœ°é¡µ
```

---

#### 3. ç³»ç»Ÿç®¡ç†å‘˜ (System Admins)

**è§’è‰²å®šä¹‰**: è´Ÿè´£ç³»ç»Ÿè¿ç»´ã€ç›‘æ§å’Œç®¡ç†çš„æŠ€æœ¯äººå‘˜ã€‚

**äº¤äº’æ–¹å¼**:
- **ç³»ç»Ÿç®¡ç†**: ç®¡ç†ç”¨æˆ·ã€å®¡æ ¸æ¶æ„é“¾æ¥ã€å¤„ç†ä¸¾æŠ¥
- **ç›‘æ§æ€§èƒ½**: æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡
- **æ•°æ®åº“ç»´æŠ¤**: å¤‡ä»½æ•°æ®ã€ä¼˜åŒ–æŸ¥è¯¢ã€æ¸…ç†è¿‡æœŸæ•°æ®

**ç®¡ç†å·¥å…·**:
- Prometheus + Grafana ç›‘æ§é¢æ¿
- PostgreSQL æ•°æ®åº“ç®¡ç†å·¥å…·
- Redis CLI ç¼“å­˜ç®¡ç†

---

#### 4. API å®¢æˆ·ç«¯ (API Clients)

**è§’è‰²å®šä¹‰**: é€šè¿‡ API æ¥å£ä¸ç³»ç»Ÿäº¤äº’çš„ç¬¬ä¸‰æ–¹åº”ç”¨æˆ–è„šæœ¬ã€‚

**äº¤äº’æ–¹å¼**:
- **æ‰¹é‡æ“ä½œ**: é€šè¿‡ API æ‰¹é‡åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤çŸ­é“¾æ¥
- **å¯¼å…¥/å¯¼å‡º**: æ‰¹é‡å¯¼å…¥ CSV æ–‡ä»¶,å¯¼å‡ºåˆ†ææ•°æ®

**API è®¤è¯**:
```http
POST /api/batch/links
Authorization: Bearer {api_key}
Content-Type: application/json

{
  "links": [
    {"original_url": "https://example.com/1", "custom_code": "link1"},
    {"original_url": "https://example.com/2", "custom_code": "link2"}
  ]
}
```

**ä½¿ç”¨åœºæ™¯**:
- ç”µå•†å¹³å°æ‰¹é‡ç”Ÿæˆå•†å“æ¨å¹¿é“¾æ¥
- è‡ªåŠ¨åŒ–è„šæœ¬å®šæœŸå¯¼å‡ºåˆ†ææ•°æ®

---

### ğŸ”Œ å¤–éƒ¨ç³»ç»Ÿ (External Systems)

#### 1. é‚®ä»¶æœåŠ¡ (Email Service - SMTP)

**æœåŠ¡æä¾›å•†**: SendGrid / Mailgun / é˜¿é‡Œäº‘é‚®ä»¶æ¨é€

**äº¤äº’åœºæ™¯**:
| åœºæ™¯ | è§¦å‘æ¡ä»¶ | é‚®ä»¶å†…å®¹ |
|------|----------|----------|
| **æ³¨å†ŒéªŒè¯** | ç”¨æˆ·æ³¨å†Œ | åŒ…å« 6 ä½éªŒè¯ç çš„éªŒè¯é‚®ä»¶ |
| **å¯†ç é‡ç½®** | ç”¨æˆ·å¿˜è®°å¯†ç  | åŒ…å«é‡ç½®é“¾æ¥çš„é‚®ä»¶ |
| **å›¢é˜Ÿé‚€è¯·** | ç®¡ç†å‘˜é‚€è¯·æˆå‘˜ | åŒ…å«é‚€è¯·é“¾æ¥çš„é‚®ä»¶ |
| **æ¯å‘¨æŠ¥å‘Š** | æ¯å‘¨ä¸€å‡Œæ™¨ | ä¸Šå‘¨é“¾æ¥è®¿é—®ç»Ÿè®¡æŠ¥å‘Š |

**é…ç½®ç¤ºä¾‹**:
```typescript
const emailConfig = {
  host: 'smtp.sendgrid.net',
  port: 587,
  auth: {
    user: 'apikey',
    pass: process.env.SENDGRID_API_KEY
  }
}
```

---

#### 2. åœ°ç†ä½ç½®æœåŠ¡ (GeoIP Service)

**å®ç°æ–¹å¼**: `geoip-lite` (æœ¬åœ°æ•°æ®åº“,æ— éœ€å¤–éƒ¨ API è°ƒç”¨)

**åŠŸèƒ½**:
- æ ¹æ® IP åœ°å€è§£æå›½å®¶ã€çœä»½ã€åŸå¸‚
- æ”¯æŒç¦»çº¿æŸ¥è¯¢,å“åº”æ—¶é—´ < 1ms

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
import geoip from 'geoip-lite'

const ip = '220.181.38.148'
const geo = geoip.lookup(ip)

console.log(geo)
// {
//   country: 'CN',
//   region: 'GD',
//   city: 'Guangzhou',
//   ll: [23.1167, 113.25]
// }
```

**æ•°æ®æ¥æº**: MaxMind GeoLite2 æ•°æ®åº“ (æ¯æœˆæ›´æ–°)

---

#### 3. å†…å®¹åˆ†å‘ç½‘ç»œ (CDN)

**æœåŠ¡æä¾›å•†**: CloudFlare / é˜¿é‡Œäº‘ CDN / è…¾è®¯äº‘ CDN

**åŠ é€Ÿå†…å®¹**:
- é™æ€èµ„æº (JS/CSS/å›¾ç‰‡)
- äºŒç»´ç å›¾ç‰‡
- è½åœ°é¡µ HTML

**é…ç½®**:
```nginx
# Nginx é…ç½®
location ~* \.(js|css|png|jpg|jpeg|gif|svg|woff|woff2)$ {
  expires 1y;
  add_header Cache-Control "public, immutable";
}
```

**æ€§èƒ½æå‡**:
- å…¨çƒè®¿é—®å»¶è¿Ÿ < 100ms
- å‡å°‘æºç«™å¸¦å®½ 70%

---

#### 4. ç›‘æ§æœåŠ¡ (Monitoring)

**æŠ€æœ¯æ ˆ**: Prometheus (æŒ‡æ ‡æ”¶é›†) + Grafana (å¯è§†åŒ–)

**ç›‘æ§æŒ‡æ ‡**:
| æŒ‡æ ‡ç±»å‹ | å…·ä½“æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ |
|----------|----------|----------|
| **åº”ç”¨æ€§èƒ½** | è¯·æ±‚å“åº”æ—¶é—´ | > 500ms |
| **ç³»ç»Ÿèµ„æº** | CPU ä½¿ç”¨ç‡ | > 80% |
| **æ•°æ®åº“** | è¿æ¥æ± ä½¿ç”¨ç‡ | > 90% |
| **ç¼“å­˜** | Redis å†…å­˜ä½¿ç”¨ç‡ | > 85% |
| **ä¸šåŠ¡æŒ‡æ ‡** | çŸ­é“¾æ¥åˆ›å»ºå¤±è´¥ç‡ | > 1% |
| **é”™è¯¯ç‡** | 5xx é”™è¯¯ç‡ | > 0.5% |

**å‘Šè­¦é€šçŸ¥**:
- é’‰é’‰æœºå™¨äºº / ä¼ä¸šå¾®ä¿¡
- çŸ­ä¿¡é€šçŸ¥ (ä¸¥é‡æ•…éšœ)

---

### ğŸ’¾ æ•°æ®å­˜å‚¨ (Data Storage)

#### 1. PostgreSQL (ä¸»æ•°æ®åº“)

**ç”¨é€”**: æŒä¹…åŒ–å­˜å‚¨æ‰€æœ‰ä¸šåŠ¡æ•°æ®

**æ•°æ®è¡¨**:
- `users` - ç”¨æˆ·è´¦å·
- `short_links` - çŸ­é“¾æ¥
- `click_logs` - ç‚¹å‡»æ—¥å¿—
- `landing_pages` - è½åœ°é¡µ
- `teams` - å›¢é˜Ÿ
- `team_members` - å›¢é˜Ÿæˆå‘˜
- `api_keys` - API å¯†é’¥

**é«˜å¯ç”¨é…ç½®**:
- ä¸»ä»å¤åˆ¶ (Master-Replica)
- è‡ªåŠ¨æ•…éšœåˆ‡æ¢ (Patroni)
- å®šæœŸå¤‡ä»½ (æ¯æ—¥å…¨é‡ + æ¯å°æ—¶å¢é‡)

---

#### 2. Redis (ç¼“å­˜æ•°æ®åº“)

**ç”¨é€”**: é«˜é€Ÿç¼“å­˜,å‡å°‘æ•°æ®åº“æŸ¥è¯¢

**ç¼“å­˜æ•°æ®**:
| Key æ ¼å¼ | æ•°æ®å†…å®¹ | TTL |
|----------|----------|-----|
| `link:{short_code}` | åŸå§‹ URL | 24h |
| `user:profile:{user_id}` | ç”¨æˆ·èµ„æ–™ | 1h |
| `analytics:{link_id}:range:{start}-{end}` | åˆ†ææ•°æ® | 1h |
| `session:{user_id}` | JWT Token å“ˆå¸Œ | 7d |
| `invite:{code}` | å›¢é˜Ÿé‚€è¯·ä¿¡æ¯ | 7d |

**é›†ç¾¤é…ç½®**:
- Redis Cluster (3 ä¸» 3 ä»)
- æŒä¹…åŒ–: AOF + RDB

---

#### 3. æ–‡ä»¶å­˜å‚¨ (File Storage)

**ç”¨é€”**: å­˜å‚¨äºŒç»´ç å›¾ç‰‡ã€ç”¨æˆ·å¤´åƒç­‰é™æ€æ–‡ä»¶

**å®ç°æ–¹å¼**:
- **å¼€å‘ç¯å¢ƒ**: æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
- **ç”Ÿäº§ç¯å¢ƒ**: é˜¿é‡Œäº‘ OSS / AWS S3

**å­˜å‚¨ç»“æ„**:
```
/storage
â”œâ”€â”€ qrcodes/
â”‚   â”œâ”€â”€ abc123.png
â”‚   â””â”€â”€ xyz789.png
â”œâ”€â”€ avatars/
â”‚   â””â”€â”€ user_12345.jpg
â””â”€â”€ exports/
    â””â”€â”€ analytics_2025-01-10.csv
```

---

### ğŸ”„ æ•°æ®æµè¯´æ˜

#### ç”¨æˆ·è®¿é—®çŸ­é“¾æ¥æµç¨‹

```
1. ç”¨æˆ·åœ¨æµè§ˆå™¨è¾“å…¥ https://tinybridge.link/abc123
2. è¯·æ±‚åˆ°è¾¾ CDN (CloudFlare)
3. CDN è½¬å‘åˆ° TinyBridge åº”ç”¨æœåŠ¡å™¨
4. åº”ç”¨æŸ¥è¯¢ Redis ç¼“å­˜
   - ç¼“å­˜å‘½ä¸­: ç›´æ¥è¿”å›åŸå§‹ URL
   - ç¼“å­˜æœªå‘½ä¸­: æŸ¥è¯¢ PostgreSQL,å†™å…¥ Redis
5. å¼‚æ­¥è®°å½•ç‚¹å‡»æ—¥å¿—:
   - æå– IP åœ°å€
   - è°ƒç”¨ geoip-lite è§£æåœ°ç†ä½ç½®
   - IP å“ˆå¸Œ (SHA256 + Salt)
   - å†™å…¥ PostgreSQL click_logs è¡¨
6. è¿”å› 302 é‡å®šå‘åˆ°åŸå§‹ URL
7. ç”¨æˆ·æµè§ˆå™¨è·³è½¬åˆ°ç›®æ ‡ç½‘ç«™
```

**å“åº”æ—¶é—´**: < 100ms (ç¼“å­˜å‘½ä¸­ < 10ms)

---

### ğŸ“Š ç³»ç»Ÿå®¹é‡è§„åˆ’

| æŒ‡æ ‡ | è®¾è®¡å®¹é‡ | å³°å€¼å®¹é‡ |
|------|----------|----------|
| **ç”¨æˆ·æ•°** | 10,000 | 50,000 |
| **çŸ­é“¾æ¥æ•°** | 1,000,000 | 5,000,000 |
| **æ—¥è®¿é—®é‡** | 100,000 | 500,000 |
| **å¹¶å‘è¯·æ±‚** | 1,000 req/s | 5,000 req/s |
| **æ•°æ®åº“å¤§å°** | 10 GB | 100 GB |
| **Redis ç¼“å­˜** | 4 GB | 16 GB |

---

### ğŸ”’ å®‰å…¨è¾¹ç•Œ

| è¾¹ç•Œ | å®‰å…¨æªæ–½ |
|------|----------|
| **ç”¨æˆ· â†” ç³»ç»Ÿ** | HTTPS åŠ å¯† + JWT è®¤è¯ |
| **API å®¢æˆ·ç«¯ â†” ç³»ç»Ÿ** | API Key è®¤è¯ + é€Ÿç‡é™åˆ¶ |
| **ç³»ç»Ÿ â†” æ•°æ®åº“** | å†…ç½‘è®¿é—® + å¯†ç è®¤è¯ |
| **ç³»ç»Ÿ â†” Redis** | å¯†ç è®¤è¯ + ACL æƒé™æ§åˆ¶ |
| **ç³»ç»Ÿ â†” é‚®ä»¶æœåŠ¡** | TLS åŠ å¯† + API Key |

---

### ğŸŒ éƒ¨ç½²æ¶æ„

```
[ç”¨æˆ·æµè§ˆå™¨]
    â†“ HTTPS
[CloudFlare CDN]
    â†“
[Nginx è´Ÿè½½å‡è¡¡å™¨]
    â†“ (Round Robin)
[TinyBridge åº”ç”¨æœåŠ¡å™¨] x3 (Docker å®¹å™¨)
    â†“
[PostgreSQL ä¸»ä»é›†ç¾¤]
[Redis é›†ç¾¤]
[é˜¿é‡Œäº‘ OSS]
```

**æœåŠ¡å™¨é…ç½®** (ç”Ÿäº§ç¯å¢ƒ):
- **åº”ç”¨æœåŠ¡å™¨**: 2 æ ¸ 4GB x 3 å°
- **PostgreSQL**: 4 æ ¸ 8GB + 100GB SSD
- **Redis**: 2 æ ¸ 4GB
- **Nginx**: 2 æ ¸ 2GB

---

### ğŸ“ˆ æ‰©å±•æ€§è®¾è®¡

| æ‰©å±•æ–¹å‘ | å®ç°æ–¹å¼ |
|----------|----------|
| **æ°´å¹³æ‰©å±•** | æ— çŠ¶æ€åº”ç”¨æœåŠ¡å™¨,æ”¯æŒåŠ¨æ€å¢å‡å®ä¾‹ |
| **æ•°æ®åº“æ‰©å±•** | è¯»å†™åˆ†ç¦»,åˆ†åº“åˆ†è¡¨ (æŒ‰ user_id åˆ†ç‰‡) |
| **ç¼“å­˜æ‰©å±•** | Redis Cluster åŠ¨æ€å¢åŠ èŠ‚ç‚¹ |
| **å­˜å‚¨æ‰©å±•** | å¯¹è±¡å­˜å‚¨ (OSS) è‡ªåŠ¨æ‰©å®¹ |
